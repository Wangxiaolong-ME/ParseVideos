# 测试用例文档

本目录包含了视频下载器项目的完整测试套件，共计 **171个测试用例**，覆盖了所有核心功能模块。

## 📁 测试文件结构

```
src/tests/
├── README.md                      # 本文档
├── test_douyin_download.py        # 抖音下载模块测试 (27个用例)
├── test_bilibili_download.py      # B站下载模块测试 (28个用例)
├── test_music_download.py         # 网易云音乐测试 (24个用例)
├── test_xiaohongshu_download.py   # 小红书下载测试 (24个用例)
├── test_telegram_bot.py           # Telegram机器人测试 (33个用例)
└── test_public_methods.py         # 公共方法模块测试 (35个用例)
```

## 🧪 测试用例详细说明

### 1. 抖音下载模块测试 (`test_douyin_download.py`)

**核心类测试：`TestDouyinPost` (25个用例)**
- ✅ **初始化测试**：验证 `DouyinPost` 类的正确初始化
- ✅ **解析功能**：测试链接解析、内容提取、错误处理
- ✅ **内容类型检测**：验证视频/图片类型自动判断
- ✅ **排序功能**：按分辨率、码率、文件大小排序测试
- ✅ **筛选功能**：文件大小范围筛选、最值筛选
- ✅ **去重功能**：多种去重策略测试（最高码率、最大文件等）
- ✅ **选项获取**：按分辨率获取、策略获取测试
- ✅ **下载功能**：单个/批量下载、异步下载测试
- ✅ **元数据管理**：保存/加载元数据功能
- ✅ **链式操作**：支持方法链式调用验证
- ✅ **错误处理**：无效URL、网络错误等异常情况

**数据模型测试：`TestVideoOption` (2个用例)**
- ✅ **对象创建**：`VideoOption` 数据模型验证
- ✅ **对象比较**：相等性比较逻辑测试

### 2. B站下载模块测试 (`test_bilibili_download.py`)

**核心类测试：`TestBilibiliPost` (27个用例)**
- ✅ **初始化测试**：基本初始化、默认参数验证
- ✅ **信息获取**：视频信息获取、解析错误处理
- ✅ **分辨率筛选**：按质量ID、描述筛选、错误处理
- ✅ **质量选择**：最高/最低画质自动选择
- ✅ **数据更新**：选择后的属性自动更新
- ✅ **大小筛选**：文件大小范围筛选、单边筛选
- ✅ **预览功能**：预览视频下载测试
- ✅ **下载功能**：视频音频下载、预览模式下载
- ✅ **合并功能**：ffmpeg视频音频合并、自定义输出
- ✅ **错误处理**：合并失败、文件缺失等异常
- ✅ **链式操作**：复杂的链式调用流程验证
- ✅ **边界情况**：空选项、无效分辨率处理

**集成测试：`TestBilibiliPostIntegration` (1个用例)**
- ✅ **完整工作流**：从获取信息到合并输出的完整流程模拟

### 3. 网易云音乐测试 (`test_music_download.py`)

**核心功能测试：`TestMusicDownloadCore` (12个用例)**
- ✅ **链接解析**：获取真实下载链接、歌曲信息提取
- ✅ **ID返回模式**：同时返回歌曲名和ID的功能
- ✅ **URL验证**：无效URL处理、ID提取验证
- ✅ **API错误处理**：服务器错误、网络异常处理
- ✅ **文件下载**：HTTP下载、进度跟踪、错误处理
- ✅ **单曲下载**：完整单曲下载流程、缓存检查

**播放列表测试：`TestMusicPlaylistDownload` (4个用例)**
- ✅ **播放列表解析**：获取播放列表歌曲信息
- ✅ **API错误处理**：播放列表不存在、网络错误
- ✅ **ID提取**：从播放列表URL提取ID

**批量下载测试：`TestMusicDownloadBatch` (4个用例)**
- ✅ **批量处理**：从文件读取URL批量下载
- ✅ **失败处理**：部分失败的批量下载处理
- ✅ **输出文件**：创建下载链接汇总文件

**主程序测试：`TestMusicDownloadMain` (4个用例)**
- ✅ **主函数执行**：完整程序流程测试
- ✅ **API配置验证**：请求头、请求体格式验证
- ✅ **文件名处理**：特殊字符清理、Unicode支持

**集成测试：`TestMusicDownloadIntegration` (1个用例)**
- ✅ **完整工作流**：从链接解析到文件下载的完整流程

### 4. 小红书下载测试 (`test_xiaohongshu_download.py`)

**核心类测试：`TestXiaohongshuPost` (20个用例)**
- ✅ **初始化验证**：类属性、保存目录检查
- ✅ **URL识别**：有效/无效小红书URL判断
- ✅ **URL清理**：提取干净的基础URL
- ✅ **ID提取**：从URL中提取笔记ID
- ✅ **下载功能**：图片/视频下载、失败处理
- ✅ **内容解析**：视频内容、图片内容、混合内容解析
- ✅ **数据处理**：空数据、缺失媒体数据处理
- ✅ **页面获取**：HTTP请求、错误处理、Cookie支持
- ✅ **文件名生成**：标题清理、特殊字符处理
- ✅ **目录管理**：不同内容类型的目录创建

**集成测试：`TestXiaohongshuPostIntegration` (4个用例)**
- ✅ **视频下载流程**：完整视频下载工作流程
- ✅ **图片下载流程**：完整图片下载工作流程
- ✅ **错误恢复**：各种异常情况的健壮性测试
- ✅ **边界情况**：URL边界情况处理

### 5. Telegram机器人测试 (`test_telegram_bot.py`)

**速率限制器：`TestRateLimiter` (5个用例)**
- ✅ **初始化验证**：限制器基本配置
- ✅ **首次调用**：首次请求允许通过
- ✅ **快速调用阻止**：连续快速调用被限制
- ✅ **间隔后允许**：超过间隔时间后允许调用
- ✅ **多用户独立**：不同用户独立限制

**任务管理器：`TestTaskManager` (5个用例)**
- ✅ **管理器初始化**：基本配置和属性验证
- ✅ **任务添加**：异步任务添加和执行
- ✅ **并发限制**：最大并发任务数量控制
- ✅ **任务取消**：运行中任务的取消功能
- ✅ **状态查询**：任务执行状态查询

**文件缓存：`TestFileCache` (6个用例)**
- ✅ **缓存初始化**：缓存目录和配置验证
- ✅ **文件添加**：向缓存添加文件
- ✅ **文件获取**：从缓存获取文件
- ✅ **缓存未命中**：不存在文件的处理
- ✅ **缓存清理**：旧文件自动清理
- ✅ **大小限制**：缓存大小限制管理

**解析结果：`TestParseResult` (3个用例)**
- ✅ **结果创建**：成功解析结果创建
- ✅ **失败情况**：解析失败结果处理
- ✅ **媒体项属性**：不同类型媒体项验证

**解析器测试：`TestParsers` (8个用例)**
- ✅ **解析器初始化**：各平台解析器初始化验证
- ✅ **解析功能**：B站、抖音、音乐、小红书解析测试

**媒体上传器：`TestMediaUploader` (3个用例)**
- ✅ **上传器初始化**：基本配置验证
- ✅ **文件大小检查**：上传文件大小验证
- ✅ **媒体上传**：视频上传功能模拟

**集成测试：`TestIntegrationScenarios` (3个用例)**
- ✅ **完整消息处理**：从接收到处理的完整工作流
- ✅ **错误处理集成**：各种错误情况的集成处理
- ✅ **性能测试**：高并发场景模拟

### 6. 公共方法模块测试 (`test_public_methods.py`)

**日志系统：`TestLogger` (6个用例)**
- ✅ **基本日志设置**：日志级别、输出配置
- ✅ **文件日志**：日志文件写入、内容验证
- ✅ **单文件模式**：特殊日志模式测试
- ✅ **日志器获取**：子日志器获取功能
- ✅ **日志级别**：不同级别日志输出验证
- ✅ **Unicode处理**：中文、emoji等特殊字符支持

**下载器：`TestDownloader` (7个用例)**
- ✅ **下载器初始化**：基本配置、线程数设置
- ✅ **简单下载**：HTTP文件下载功能
- ✅ **分段下载**：大文件分段下载逻辑
- ✅ **重试机制**：下载失败重试功能
- ✅ **进度跟踪**：下载进度回调验证
- ✅ **错误处理**：各种下载错误情况
- ✅ **并发下载**：多线程并发下载测试

**Playwright管理器：`TestPlaywrightManager` (5个用例)**
- ✅ **管理器初始化**：基本属性和方法验证
- ✅ **浏览器创建**：浏览器实例创建测试
- ✅ **页面创建**：浏览器页面创建功能
- ✅ **用户代理设置**：不同平台用户代理配置
- ✅ **视口设置**：不同设备视口尺寸配置

**工具函数：`TestTools` (7个用例)**
- ✅ **curl命令准备**：HTTP请求转curl命令
- ✅ **带数据curl**：POST请求curl命令生成
- ✅ **文件名清理**：特殊字符清理功能
- ✅ **边界情况处理**：文件名清理边界测试
- ✅ **文件大小检查**：文件大小获取功能
- ✅ **不存在文件**：不存在文件的处理
- ✅ **扩展名处理**：文件扩展名提取验证

**超时装饰器：`TestTimeoutDecorator` (5个用例)**
- ✅ **基本超时**：函数执行超时控制
- ✅ **超时情况**：超时异常处理验证
- ✅ **带参数函数**：参数传递功能测试
- ✅ **异步函数**：异步函数超时装饰
- ✅ **异常处理**：原始异常正确传播

**集成测试：`TestIntegrationPublicMethods` (5个用例)**
- ✅ **日志下载器集成**：日志系统与下载器协作
- ✅ **文件操作集成**：多种文件操作的集成测试
- ✅ **错误处理集成**：错误情况下的组件协作
- ✅ **性能监控集成**：性能监控功能集成
- ✅ **资源清理集成**：资源清理机制验证

## 🏷️ 测试标记说明

项目使用 pytest 标记系统对测试进行分类：

- `@pytest.mark.unit` - 单元测试，测试单个函数或方法
- `@pytest.mark.integration` - 集成测试，测试多个组件协作
- `@pytest.mark.slow` - 慢速测试，执行时间较长的测试
- `@pytest.mark.network` - 需要网络连接的测试
- `@pytest.mark.file_system` - 需要文件系统操作的测试

## 🚀 运行测试

### 使用测试脚本（推荐）

```bash
# 显示测试信息
python run_tests.py

# 运行所有测试
python run_tests.py -m all

# 运行特定模块测试
python run_tests.py -m douyin          # 抖音模块
python run_tests.py -m bilibili        # B站模块
python run_tests.py -m music           # 音乐模块
python run_tests.py -m xiaohongshu     # 小红书模块
python run_tests.py -m telegram        # Telegram机器人
python run_tests.py -m public          # 公共方法

# 按测试类型运行
python run_tests.py -t unit            # 只运行单元测试
python run_tests.py -t integration     # 只运行集成测试

# 快速模式（跳过慢速测试）
python run_tests.py -f

# 生成覆盖率报告
python run_tests.py -c

# 生成HTML报告
python run_tests.py --report

# 详细输出
python run_tests.py -v

# 失败时停止
python run_tests.py -x

# 清理缓存
python run_tests.py --clean
```

### 直接使用 pytest

```bash
# 运行所有测试
pytest src/tests/

# 运行特定文件
pytest src/tests/test_douyin_download.py

# 运行特定测试类
pytest src/tests/test_douyin_download.py::TestDouyinPost

# 运行特定测试方法
pytest src/tests/test_douyin_download.py::TestDouyinPost::test_01_douyin_post_initialization

# 按标记运行
pytest -m unit                         # 只运行单元测试
pytest -m "not slow"                   # 跳过慢速测试
pytest -m "network"                    # 只运行需要网络的测试

# 详细输出
pytest -v src/tests/

# 覆盖率报告
pytest --cov=src --cov-report=html src/tests/

# 并行运行（需要 pytest-xdist）
pytest -n 4 src/tests/
```

## 📊 测试覆盖范围

### 功能覆盖
- ✅ **URL解析与验证** - 所有平台的链接格式验证
- ✅ **内容信息提取** - 标题、作者、时长等元数据
- ✅ **媒体文件下载** - 视频、音频、图片下载
- ✅ **质量选择与筛选** - 分辨率、码率、文件大小筛选
- ✅ **文件格式转换** - 视频音频合并、格式转换
- ✅ **缓存机制** - 文件缓存、元数据缓存
- ✅ **错误处理** - 网络错误、解析错误、文件错误
- ✅ **并发控制** - 多线程下载、速率限制
- ✅ **日志记录** - 详细的操作日志
- ✅ **配置管理** - 环境变量、配置文件

### 平台覆盖
- ✅ **抖音 (Douyin)** - 视频/图集下载、多清晰度支持
- ✅ **哔哩哔哩 (Bilibili)** - 视频下载、音视频分离合并
- ✅ **网易云音乐** - 音乐下载、播放列表支持
- ✅ **小红书 (XiaoHongShu)** - 图文/视频内容下载
- ✅ **Telegram机器人** - 消息处理、媒体上传

### 场景覆盖
- ✅ **正常使用场景** - 标准功能流程
- ✅ **异常情况** - 网络错误、文件不存在、权限问题
- ✅ **边界条件** - 超大文件、特殊字符、空数据
- ✅ **性能测试** - 并发下载、大批量处理
- ✅ **兼容性测试** - 不同操作系统、Python版本

## 🔧 测试配置

测试配置文件 `pytest.ini` 包含：

- 测试发现规则
- 日志配置
- 标记定义
- 默认选项
- 警告过滤

## 📝 贡献指南

### 添加新测试

1. **选择合适的测试文件**：根据功能模块选择对应的测试文件
2. **遵循命名规范**：测试类以 `Test` 开头，测试方法以 `test_` 开头
3. **添加编号和描述**：每个测试方法包含编号和中文描述
4. **使用适当的标记**：为测试添加合适的 pytest 标记
5. **编写清晰的文档字符串**：描述测试目的和验证内容
6. **包含断言验证**：确保测试有明确的成功/失败判断

### 测试最佳实践

1. **独立性**：每个测试应该独立运行，不依赖其他测试
2. **可重复性**：测试结果应该一致和可预测
3. **清晰性**：测试意图应该明确易懂
4. **完整性**：覆盖正常情况、异常情况和边界条件
5. **维护性**：测试代码应该易于维护和更新

## 📈 测试报告

运行测试后可以生成多种报告：

- **终端输出**：实时测试结果
- **HTML报告**：详细的测试执行报告
- **覆盖率报告**：代码覆盖率分析
- **JUnit XML**：用于CI/CD集成
- **日志文件**：详细的执行日志

## 🎯 质量保证

所有测试用例都经过精心设计，确保：

- ✅ **功能完整性** - 覆盖所有主要功能点
- ✅ **异常处理** - 验证错误情况的正确处理
- ✅ **性能要求** - 确保性能指标满足要求
- ✅ **兼容性** - 支持不同环境和配置
- ✅ **可维护性** - 测试代码结构清晰，易于维护

---

**总测试用例数：171个**  
**覆盖率目标：> 85%**  
**维护状态：✅ 活跃维护**

如有测试相关问题，请查看具体测试文件中的详细注释或联系开发团队。